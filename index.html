<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>Academia NH v3</title>
  <link rel="stylesheet" href="styles.css?v=4" />
</head>
<body>
  <header>
    <div class="brand">
      <img src="icons/icon-192.png" alt="Logo" />
      <h1 id="brand-title">Academia NH v3</h1>
    </div>
    <nav id="tabs">
      <button data-tab="kiosk" class="active">Asistencias</button>
      <button data-tab="students" data-admin>Alumnos</button>
      <button data-tab="payments" data-admin>Pagos</button>
      <button data-tab="reports" data-admin>Reportes</button>
      <button data-tab="config" data-admin>Config</button>
      <span class="spacer"></span>
      <select id="mode-switch" title="Modo">
        <option value="alumno">Modo Alumno</option>
        <option value="admin">Modo Admin</option>
      </select>
    </nav>
  </header>

  <!-- ADMIN LOGIN OVERLAY -->
  <div id="admin-overlay" class="overlay" aria-hidden="true">
    <div class="overlay-card">
      <h3>PIN de Administrador</h3>
      <input id="admin-pin-input" inputmode="numeric" pattern="\d{4}" maxlength="4" placeholder="••••" />
      <div class="pad">
        <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
        <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
        <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button>
        <button data-k="←">←</button><button data-k="0">0</button><button data-k="OK">OK</button>
      </div>
      <div class="overlay-actions">
        <button id="admin-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <main>
    <!-- KIOSK / ALUMNO -->
    <section id="kiosk" class="tab active">
      <h2>Marcaje por PIN (Alumno)</h2>
      <div class="pin-box">
        <form id="form-pin" class="form-inline">
          <input name="pin" inputmode="numeric" maxlength="4" pattern="\d{4}" placeholder="PIN ••••" required />
          <button>Marcar</button>
        </form>
        <div id="kiosk-profile" class="kiosk-profile" aria-live="polite"></div>
      </div>
      <div class="table-wrap">
        <table id="table-attendance">
          <thead><tr><th>Fecha</th><th>Alumno</th><th>Grupo</th><th>Asistencia</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- STUDENTS / ADMIN -->
    <section id="students" class="tab">
      <h2>Alumnos</h2>
      <form id="form-student" class="form-grid">
        <input name="full_name" placeholder="Nombre completo" required />
        <input name="phone" placeholder="Teléfono" />
        <label class="file-uploader"><span>Foto</span><input id="student-photo" type="file" accept="image/*" capture="environment" /></label>
        <select name="classes" id="student-classes" required>
          <option value="">Paquete (clases)</option>
        </select>
        <input name="amount_mxn" id="student-amount" type="number" placeholder="Monto MXN" min="0" step="0.01" required />
        <select name="payment_status" required>
          <option value="">Estado de pago</option>
          <option value="pagado">Pagado</option>
          <option value="pendiente">Pendiente</option>
        </select>
        <button>+ Agregar alumno</button>
      </form>

      <div class="table-wrap">
        <table id="table-students">
          <thead><tr><th>Foto</th><th>Nombre</th><th>Teléfono</th><th>Paquete</th><th>Restantes</th><th>Fin</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="student-profile" class="card" style="display:none">
        <h3 id="sp-name"></h3>
        <div class="grid-2">
          <div>
            <img id="sp-photo" class="profile-photo" alt="Foto" />
            <button id="sp-photo-btn">Actualizar foto</button>
          </div>
          <div>
            <label>Nombre <input id="sp-full_name"/></label>
            <label>Teléfono <input id="sp-phone"/></label>
            <label>Clases del paquete <select id="sp-classes"></select></label>
            <label>Monto MXN <input id="sp-amount" type="number" min="0" step="0.01"/></label>
            <label>Pago <select id="sp-payment">
              <option value="pagado">Pagado</option>
              <option value="pendiente">Pendiente</option>
            </select></label>
            <label>Fin <input id="sp-end" type="date"/></label>
            <div class="form-inline">
              <button id="sp-save">Guardar cambios</button>
              <button id="sp-reagenda" class="accent">Reagendar</button>
              <button id="sp-close" class="danger-outline">Cerrar paquete</button>
            </div>
          </div>
        </div>

        <h4>Historial de pagos</h4>
        <div class="table-wrap">
          <table id="table-sp-payments">
            <thead><tr><th>Fecha</th><th>Monto</th><th>Método</th><th>Estado</th><th>Ref</th><th>Acción</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PAYMENTS / ADMIN -->
    <section id="payments" class="tab">
      <h2>Pagos</h2>
      <form id="form-payment" class="form-inline">
        <select name="student_id" required></select>
        <input name="amount_mxn" type="number" min="0" step="0.01" placeholder="Monto MXN" required/>
        <select name="method"><option value="">Método</option><option>efectivo</option><option>transferencia</option></select>
        <select name="status"><option value="">Estado</option><option value="pagado">Pagado</option><option value="pendiente">Pendiente</option></select>
        <input name="reference" placeholder="Referencia"/>
        <button>Registrar pago</button>
      </form>
      <div class="table-wrap">
        <table id="table-payments">
          <thead><tr><th>Fecha</th><th>Alumno</th><th>Método</th><th>Monto</th><th>Estado</th><th>Ref</th><th>Acción</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- REPORTS / ADMIN -->
    <section id="reports" class="tab">
      <h2>Reportes</h2>
      <div class="grid">
        <div class="card"><h3>Asistencias (mes)</h3><p id="r-att-month">0</p></div>
        <div class="card"><h3>Ingresos (mes)</h3><p id="r-income-month">$0.00</p></div>
      </div>
    </section>

    <!-- CONFIG / ADMIN -->
    <section id="config" class="tab">
      <h2>Configuración</h2>
      <div class="form-grid">
        <input id="cfg-brand" placeholder="Nombre academia" value="Academia NH v3"/>
        <input id="cfg-admin-pin" placeholder="PIN Admin (4 dígitos)" maxlength="4" inputmode="numeric"/>
        <input id="cfg-voice-ok" placeholder='Voz OK' value="Acceso otorgado"/>
        <input id="cfg-voice-deny" placeholder='Voz NO' value="Acceso denegado"/>
        <button id="cfg-save">Guardar</button>
        <button id="cfg-clear" class="danger-outline">Borrar caché</button>
      </div>
    </section>
  </main>

  <footer><small>PWA localStorage • Compatible iPad • Voz offline en español.</small></footer>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js?v=4'); });
    }
    // Panic clear
    (async()=>{
      const params=new URLSearchParams(location.search);
      if(params.get('clear')==='1'){
        try{
          if('caches' in window){ const keys=await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); }
          if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r=>r.unregister())); }
        }catch(e){}
        setTimeout(()=>location.replace(location.pathname+'?v=clean4'),300);
      }
    })();
  </script>
  <script src="app.js?v=4"></script>
</body>
</html>
